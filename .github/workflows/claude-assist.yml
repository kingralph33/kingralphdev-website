name: Claude Assist

# On-demand workflow triggered by @claude mentions in comments
# Inspired by Anthropic's claude-code workflow pattern
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  assist:
    # Only run when @claude is explicitly mentioned
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude'))

    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10
          run_install: false

      - name: Install dependencies
        run: pnpm install

      - name: Parse Claude command
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment?.body || context.payload.review?.body || '';

            // Extract command after @claude
            const match = body.match(/@claude\s+(.+?)(?:\n|$)/);
            const command = match ? match[1].trim() : 'help';

            core.setOutput('command', command);
            core.setOutput('full_body', body);

            // Detect command type
            if (command.includes('review') || command.includes('check')) {
              core.setOutput('task', 'review');
            } else if (command.includes('test')) {
              core.setOutput('task', 'test');
            } else if (command.includes('lint') || command.includes('format')) {
              core.setOutput('task', 'lint');
            } else if (command.includes('build')) {
              core.setOutput('task', 'build');
            } else {
              core.setOutput('task', 'help');
            }

      - name: Run tests
        if: steps.parse.outputs.task == 'test'
        run: |
          echo "üß™ Running tests as requested by @claude..."
          pnpm test:unit
          npx playwright install --with-deps chromium
          pnpm test:e2e

      - name: Run linter
        if: steps.parse.outputs.task == 'lint'
        run: |
          echo "üîç Running linter as requested by @claude..."
          pnpm lint

      - name: Run build
        if: steps.parse.outputs.task == 'build'
        run: |
          echo "üèóÔ∏è Running build as requested by @claude..."
          pnpm build

      - name: Post help message
        if: steps.parse.outputs.task == 'help'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `üëã Hi! I'm Claude Assist. Here are the commands I can help with:

            **Available Commands:**
            - \`@claude test\` - Run full test suite (unit + E2E)
            - \`@claude lint\` - Run ESLint checks
            - \`@claude build\` - Run production build
            - \`@claude review\` - Request code review (coming soon)

            **Examples:**
            - \`@claude test\` - Runs all tests and reports results
            - \`@claude lint\` - Checks code style and reports issues

            Simply mention me with a command in any PR or issue comment!`;

            if (context.payload.comment) {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: comment
              });
            }

      - name: Post results
        if: always() && steps.parse.outputs.task != 'help'
        uses: actions/github-script@v7
        with:
          script: |
            const task = '${{ steps.parse.outputs.task }}';
            const status = '${{ job.status }}';

            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            const message = status === 'success'
              ? `${emoji} **${task}** completed successfully!`
              : `${emoji} **${task}** failed. Check the workflow logs for details.`;

            const comment = `${message}

            [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            if (context.payload.comment) {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: comment
              });
            }
